box: 
  id: s1061123/qmk_firmware:devel

build:
  steps:
    - script:
        name: build default keymap.
        cwd: $WERCKER_SOURCE_DIR/
        code: |
                make $KEYBOARD:$TARGET_KEYMAP
    - script:
        name: move built firmware to output dir.
        cwd: $WERCKER_SOURCE_DIR/
        code: |
                mv .build/ergodox_ez_$TARGET_KEYMAP.hex $WERCKER_OUTPUT_DIR
deploy:
  steps:
    - script:
      name: install curl
      code: |
              apt-get update
              apt-get -y install curl
    - script:
        name: put built hex file to bintray.
        code: |
                curl -T $WERCKER_SOURCE_DIR/ergodox_ez_$TARGET_KEYMAP.hex -u$BINTRAY_USERNAME:$BINTRAY_APIKEY https://api.bintray.com/content/$BINTRAY_USERNAME/generic/ergodox.hex/$WERCKER_GIT_BRANCH-$WERCKER_GIT_COMMIT/$WERCKER_GIT_BRANCH-$WERCKER_GIT_COMMIT/ergodox_ez_$TARGET_KEYMAP.hex
    - script:
        name: publish uploaded hex file. 
        code: |
                curl -X POST -u$BINTRAY_USERNAME:$BINTRAY_APIKEY https://api.bintray.com/content/$BINTRAY_USERNAME/generic/ergodox.hex/$WERCKER_GIT_BRANCH-$WERCKER_GIT_COMMIT/publish
    - script:
        name: put it in download list.
        code: |
                sleep 10 && curl -X PUT -H "Accept: application/json" -H "Content-type: application/json" -u$BINTRAY_USERNAME:$BINTRAY_APIKEY https://api.bintray.com/file_metadata/$BINTRAY_USERNAME/generic/$WERCKER_GIT_BRANCH-$WERCKER_GIT_COMMIT/ergodox_ez_$TARGET_KEYMAP.hex -d '{"list_in_downloads":true}'
